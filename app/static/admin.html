<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - La FÃ³rmula</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --wa-green: #25D366;
  --wa-dark: #111B21;
  --wa-sidebar: #202C33;
  --wa-chat-bg: #0B141A;
  --wa-input-bg: #2A3942;
  --wa-header: #202C33;
  --wa-text: #E9EDEF;
  --wa-text-secondary: #8696A0;
  --wa-border: #2A3942;
  --wa-hover: #2A3942;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--wa-dark);
  color: var(--wa-text);
  min-height: 100vh;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 0;
  border-bottom: 1px solid var(--wa-border);
  margin-bottom: 0;
}

.header h1 { font-size: 20px; font-weight: 500; }

.header a {
  color: var(--wa-green);
  text-decoration: none;
  font-size: 14px;
}
.header a:hover { text-decoration: underline; }

/* --- TABS --- */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--wa-border);
  margin-bottom: 24px;
}

.tab {
  padding: 12px 24px;
  background: none;
  border: none;
  color: var(--wa-text-secondary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: color 0.15s, border-color 0.15s;
}
.tab:hover { color: var(--wa-text); }
.tab.active {
  color: var(--wa-green);
  border-bottom-color: var(--wa-green);
}

.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}

/* --- SECTIONS --- */
.section {
  background: var(--wa-sidebar);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 16px;
}

.section h2 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section p.desc {
  font-size: 13px;
  color: var(--wa-text-secondary);
  margin-bottom: 14px;
}

/* --- FORMS --- */
.form-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.form-row.vertical {
  flex-direction: column;
  align-items: stretch;
}

label {
  font-size: 13px;
  color: var(--wa-text-secondary);
  margin-bottom: 4px;
  display: block;
}

input[type="text"], textarea {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--wa-border);
  background: var(--wa-input-bg);
  color: var(--wa-text);
  font-size: 14px;
  outline: none;
  font-family: inherit;
}

input[type="text"]:focus, textarea:focus {
  border-color: var(--wa-green);
}

textarea {
  resize: vertical;
  min-height: 100px;
}

input[type="file"] {
  display: none;
}

.file-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--wa-input-bg);
  border: 1px dashed var(--wa-border);
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  color: var(--wa-text-secondary);
  transition: border-color 0.15s;
  flex: 1;
}
.file-label:hover { border-color: var(--wa-green); color: var(--wa-text); }
.file-label.has-file { border-color: var(--wa-green); color: var(--wa-green); }

.btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  transition: opacity 0.15s;
  white-space: nowrap;
}
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.4; cursor: default; }

.btn-primary {
  background: var(--wa-green);
  color: #fff;
}

.btn-danger {
  background: none;
  color: #f56565;
  padding: 6px 12px;
  font-size: 13px;
}
.btn-danger:hover { background: rgba(245,101,101,0.1); }

/* --- PROMPT EDITOR --- */
.prompt-textarea {
  min-height: 300px;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.5;
  tab-size: 4;
}

.prompt-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
}

.prompt-status {
  font-size: 12px;
  color: var(--wa-text-secondary);
}
.prompt-status.unsaved {
  color: #f6ad55;
}
.prompt-status.saved {
  color: var(--wa-green);
}

/* --- DOCUMENTS LIST --- */
.docs-section {
  background: var(--wa-sidebar);
  border-radius: 10px;
  padding: 20px;
  margin-top: 24px;
}

.docs-section h2 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.doc-count {
  font-size: 12px;
  background: var(--wa-green);
  color: #fff;
  padding: 2px 8px;
  border-radius: 10px;
}

.doc-list { list-style: none; }

.doc-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.doc-item:last-child { border-bottom: none; }

.doc-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.doc-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--wa-input-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.doc-meta .name { font-size: 14px; }
.doc-meta .detail {
  font-size: 12px;
  color: var(--wa-text-secondary);
  margin-top: 2px;
}

.empty-docs {
  text-align: center;
  padding: 30px;
  color: var(--wa-text-secondary);
  font-size: 14px;
}

/* --- TOAST --- */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 100;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--wa-green); color: #fff; }
.toast.error { background: #f56565; color: #fff; }

/* --- RESPONSIVE --- */
@media (max-width: 600px) {
  .container { padding: 12px; }
  .form-row { flex-direction: column; }
  .tab { padding: 10px 16px; font-size: 13px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Panel de Administracion</h1>
    <a href="/">&#8592; Volver al Chat</a>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="personalidad" onclick="switchTab('personalidad')">Personalidad</button>
    <button class="tab" data-tab="conocimiento" onclick="switchTab('conocimiento')">Conocimiento</button>
  </div>

  <!-- TAB: PERSONALIDAD -->
  <div class="tab-content active" id="tab-personalidad">
    <div class="section">
      <h2>Prompt del Agente</h2>
      <p class="desc">Este es el "cerebro" de Nico. Edita las reglas, el tono, los descuentos, y como se comporta. Los cambios se aplican al instante en las proximas conversaciones.</p>
      <div class="form-row vertical">
        <div>
          <textarea id="systemPrompt" class="prompt-textarea" placeholder="Cargando prompt..."></textarea>
        </div>
        <div class="prompt-footer">
          <span class="prompt-status" id="promptStatus">Sin cambios</span>
          <button class="btn btn-primary" id="btnSavePrompt" onclick="savePrompt()" disabled>Guardar cambios</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Contexto por defecto para nuevas sesiones</h2>
      <p class="desc">Texto extra que se agrega al system prompt solo para esta demo. Las sesiones nuevas copian este valor. Se guarda en memoria (se pierde al reiniciar el servidor).</p>
      <div class="form-row vertical">
        <div>
          <textarea id="defaultPromptContext" class="prompt-textarea" placeholder="Ej: El cliente de esta sesion es Juan, prefiere que le hablen de vos. Hoy hay 10% de descuento en creatina." style="min-height:120px;"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveDefaultPromptContext()">Guardar contexto por defecto</button>
      </div>
    </div>
  </div>

  <!-- TAB: CONOCIMIENTO -->
  <div class="tab-content" id="tab-conocimiento">
    <!-- Upload PDF -->
    <div class="section">
      <h2>Subir PDF</h2>
      <p class="desc">Subir catalogo, lista de precios, o cualquier documento PDF. Se extrae el texto y se indexa automaticamente.</p>
      <div class="form-row">
        <label class="file-label" id="pdfLabel" for="pdfInput">Seleccionar PDF...</label>
        <input type="file" id="pdfInput" accept=".pdf" onchange="updateFileLabel('pdfInput','pdfLabel')">
        <button class="btn btn-primary" onclick="uploadPdf()">Subir</button>
      </div>
    </div>

    <!-- Audio transcript -->
    <div class="section">
      <h2>Transcripcion de audio</h2>
      <p class="desc">Pegar la transcripcion de un audio de un cliente. Esto le da contexto al agente sobre como hablan los clientes.</p>
      <div class="form-row vertical">
        <div>
          <label>Titulo</label>
          <input type="text" id="audioTitle" placeholder="Ej: Audio cliente Juan - consulta creatina">
        </div>
        <div>
          <label>Transcripcion</label>
          <textarea id="audioText" placeholder="Ej: Hola Mauri, te queria consultar por la creatina, estoy entrenando hace 3 meses..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addAudioTranscript()" style="align-self:flex-end;">Guardar</button>
      </div>
    </div>

    <!-- Chat export -->
    <div class="section">
      <h2>Importar chat de WhatsApp</h2>
      <p class="desc">Pegar un export de chat de WhatsApp. El agente aprende del historial de conversaciones reales.</p>
      <div class="form-row vertical">
        <div>
          <label>Titulo</label>
          <input type="text" id="chatTitle" placeholder="Ej: Chat con cliente Maria - febrero 2025">
        </div>
        <div>
          <label>Export del chat</label>
          <textarea id="chatText" placeholder="6/2/25, 10:30 - Juan: Hola, tienen creatina?&#10;6/2/25, 10:31 - Mauri: Si! Tenemos monohidrato de 300g..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addChatExport()" style="align-self:flex-end;">Importar</button>
      </div>
    </div>

    <!-- Free notes -->
    <div class="section">
      <h2>Nota libre</h2>
      <p class="desc">Agregar cualquier informacion adicional: FAQ, politicas, horarios, datos del negocio, etc.</p>
      <div class="form-row vertical">
        <div>
          <label>Titulo</label>
          <input type="text" id="noteTitle" placeholder="Ej: Horarios de atencion">
        </div>
        <div>
          <label>Contenido</label>
          <textarea id="noteText" placeholder="Ej: Atendemos de lunes a viernes de 9 a 18hs. Sabados de 9 a 13hs..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addNote()" style="align-self:flex-end;">Guardar</button>
      </div>
    </div>

    <!-- Documents list -->
    <div class="docs-section">
      <h2>Documentos indexados <span class="doc-count" id="docCount">0</span></h2>
      <ul class="doc-list" id="docList">
        <li class="empty-docs">No hay documentos. Subi archivos para que Nico los use como contexto.</li>
      </ul>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// --- TABS ---
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// --- PROMPT EDITOR ---
let originalPrompt = '';

async function loadPrompt() {
  try {
    const res = await fetch('/api/config/prompt');
    const data = await res.json();
    const textarea = document.getElementById('systemPrompt');
    textarea.value = data.system_prompt;
    originalPrompt = data.system_prompt;
    updatePromptStatus();
  } catch (e) {
    console.error('Failed to load prompt:', e);
  }
}

async function savePrompt() {
  const text = document.getElementById('systemPrompt').value;
  if (!text.trim()) return showToast('El prompt no puede estar vacio', 'error');

  try {
    const res = await fetch('/api/config/prompt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ system_prompt: text }),
    });
    if (!res.ok) throw new Error();
    originalPrompt = text;
    updatePromptStatus();
    showToast('Prompt actualizado. Los cambios ya estan activos.');
  } catch (e) {
    showToast('Error al guardar el prompt', 'error');
  }
}

function updatePromptStatus() {
  const textarea = document.getElementById('systemPrompt');
  const status = document.getElementById('promptStatus');
  const btn = document.getElementById('btnSavePrompt');
  const changed = textarea.value !== originalPrompt;

  if (changed) {
    status.textContent = 'Cambios sin guardar';
    status.className = 'prompt-status unsaved';
    btn.disabled = false;
  } else {
    status.textContent = 'Sin cambios';
    status.className = 'prompt-status';
    btn.disabled = true;
  }
}

// --- DEFAULT PROMPT CONTEXT ---
async function loadDefaultPromptContext() {
  try {
    const res = await fetch('/api/config/prompt-context');
    const data = await res.json();
    document.getElementById('defaultPromptContext').value = data.prompt_context || '';
  } catch (e) {
    console.error('Failed to load default prompt context:', e);
  }
}

async function saveDefaultPromptContext() {
  const text = document.getElementById('defaultPromptContext').value;
  try {
    const res = await fetch('/api/config/prompt-context', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt_context: text || '' }),
    });
    if (!res.ok) throw new Error();
    showToast('Contexto por defecto guardado. Las nuevas sesiones lo usaran.');
  } catch (e) {
    showToast('Error al guardar', 'error');
  }
}

// --- KNOWLEDGE BASE ---
const TYPE_ICONS = {
  pdf: '\u{1F4C4}', audio_transcript: '\u{1F3A4}', chat_history: '\u{1F4AC}', note: '\u{1F4DD}'
};
const TYPE_LABELS = {
  pdf: 'PDF', audio_transcript: 'Audio', chat_history: 'Chat WA', note: 'Nota'
};

function updateFileLabel(inputId, labelId) {
  const input = document.getElementById(inputId);
  const label = document.getElementById(labelId);
  if (input.files.length > 0) {
    label.textContent = input.files[0].name;
    label.classList.add('has-file');
  }
}

// --- Toast ---
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// --- API ---
async function uploadPdf() {
  const input = document.getElementById('pdfInput');
  if (!input.files.length) return showToast('Selecciona un PDF primero', 'error');

  const form = new FormData();
  form.append('file', input.files[0]);

  try {
    const res = await fetch('/api/knowledge/upload', { method: 'POST', body: form });
    if (!res.ok) throw new Error('Upload failed');
    const data = await res.json();
    showToast(`PDF indexado: ${data.chunk_count} fragmentos`);
    input.value = '';
    document.getElementById('pdfLabel').textContent = 'Seleccionar PDF...';
    document.getElementById('pdfLabel').classList.remove('has-file');
    loadDocuments();
  } catch (e) {
    showToast('Error al subir PDF', 'error');
  }
}

async function addAudioTranscript() {
  const title = document.getElementById('audioTitle').value.trim();
  const text = document.getElementById('audioText').value.trim();
  if (!title || !text) return showToast('Completa titulo y texto', 'error');

  const form = new FormData();
  form.append('title', title);
  form.append('text', text);
  form.append('doc_type', 'audio_transcript');

  try {
    const res = await fetch('/api/knowledge/text', { method: 'POST', body: form });
    if (!res.ok) throw new Error();
    const data = await res.json();
    showToast(`Audio indexado: ${data.chunk_count} fragmentos`);
    document.getElementById('audioTitle').value = '';
    document.getElementById('audioText').value = '';
    loadDocuments();
  } catch (e) {
    showToast('Error al guardar', 'error');
  }
}

async function addChatExport() {
  const title = document.getElementById('chatTitle').value.trim();
  const text = document.getElementById('chatText').value.trim();
  if (!title || !text) return showToast('Completa titulo y chat', 'error');

  const form = new FormData();
  form.append('title', title);
  form.append('text', text);

  try {
    const res = await fetch('/api/knowledge/chat-export', { method: 'POST', body: form });
    if (!res.ok) throw new Error();
    const data = await res.json();
    showToast(`Chat importado: ${data.chunk_count} bloques`);
    document.getElementById('chatTitle').value = '';
    document.getElementById('chatText').value = '';
    loadDocuments();
  } catch (e) {
    showToast('Error al importar', 'error');
  }
}

async function addNote() {
  const title = document.getElementById('noteTitle').value.trim();
  const text = document.getElementById('noteText').value.trim();
  if (!title || !text) return showToast('Completa titulo y contenido', 'error');

  const form = new FormData();
  form.append('title', title);
  form.append('text', text);
  form.append('doc_type', 'note');

  try {
    const res = await fetch('/api/knowledge/text', { method: 'POST', body: form });
    if (!res.ok) throw new Error();
    const data = await res.json();
    showToast(`Nota guardada: ${data.chunk_count} fragmentos`);
    document.getElementById('noteTitle').value = '';
    document.getElementById('noteText').value = '';
    loadDocuments();
  } catch (e) {
    showToast('Error al guardar', 'error');
  }
}

async function deleteDoc(docId) {
  try {
    const res = await fetch(`/api/knowledge/documents/${docId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error();
    showToast('Documento eliminado');
    loadDocuments();
  } catch (e) {
    showToast('Error al eliminar', 'error');
  }
}

async function loadDocuments() {
  try {
    const res = await fetch('/api/knowledge/documents');
    const docs = await res.json();
    const list = document.getElementById('docList');
    const count = document.getElementById('docCount');
    count.textContent = docs.length;

    if (docs.length === 0) {
      list.innerHTML = '<li class="empty-docs">No hay documentos. Subi archivos para que Nico los use como contexto.</li>';
      return;
    }

    list.innerHTML = docs.map(d => `
      <li class="doc-item">
        <div class="doc-info">
          <div class="doc-icon">${TYPE_ICONS[d.doc_type] || '\u{1F4C4}'}</div>
          <div class="doc-meta">
            <div class="name">${escapeHtml(d.filename)}</div>
            <div class="detail">${TYPE_LABELS[d.doc_type] || d.doc_type} &middot; ${d.chunk_count} fragmentos</div>
          </div>
        </div>
        <button class="btn btn-danger" onclick="deleteDoc('${d.id}')">Eliminar</button>
      </li>
    `).join('');
  } catch (e) {
    console.error('Failed to load documents:', e);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// --- INIT ---
document.getElementById('systemPrompt').addEventListener('input', updatePromptStatus);
loadPrompt();
loadDefaultPromptContext();
loadDocuments();
</script>
</body>
</html>
