<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - La Fórmula</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --wa-green: #25D366;
  --wa-dark: #111B21;
  --wa-sidebar: #202C33;
  --wa-chat-bg: #0B141A;
  --wa-input-bg: #2A3942;
  --wa-header: #202C33;
  --wa-text: #E9EDEF;
  --wa-text-secondary: #8696A0;
  --wa-border: #2A3942;
  --wa-hover: #2A3942;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--wa-dark);
  color: var(--wa-text);
  min-height: 100vh;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 0;
  border-bottom: 1px solid var(--wa-border);
  margin-bottom: 0;
}

.header h1 { font-size: 20px; font-weight: 500; }

.header a {
  color: var(--wa-green);
  text-decoration: none;
  font-size: 14px;
}
.header a:hover { text-decoration: underline; }

/* --- TABS --- */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--wa-border);
  margin-bottom: 24px;
}

.tab {
  padding: 12px 24px;
  background: none;
  border: none;
  color: var(--wa-text-secondary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: color 0.15s, border-color 0.15s;
}
.tab:hover { color: var(--wa-text); }
.tab.active {
  color: var(--wa-green);
  border-bottom-color: var(--wa-green);
}

.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}

/* --- SECTIONS --- */
.section {
  background: var(--wa-sidebar);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 16px;
}

.section h2 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section p.desc {
  font-size: 13px;
  color: var(--wa-text-secondary);
  margin-bottom: 14px;
}

/* --- FORMS --- */
.form-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.form-row.vertical {
  flex-direction: column;
  align-items: stretch;
}

label {
  font-size: 13px;
  color: var(--wa-text-secondary);
  margin-bottom: 4px;
  display: block;
}

input[type="text"], textarea {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid var(--wa-border);
  background: var(--wa-input-bg);
  color: var(--wa-text);
  font-size: 14px;
  outline: none;
  font-family: inherit;
}

input[type="text"]:focus, textarea:focus {
  border-color: var(--wa-green);
}

textarea {
  resize: vertical;
  min-height: 100px;
}

input[type="file"] {
  display: none;
}

.file-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--wa-input-bg);
  border: 1px dashed var(--wa-border);
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  color: var(--wa-text-secondary);
  transition: border-color 0.15s;
  flex: 1;
}
.file-label:hover { border-color: var(--wa-green); color: var(--wa-text); }
.file-label.has-file { border-color: var(--wa-green); color: var(--wa-green); }

.btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  transition: opacity 0.15s;
  white-space: nowrap;
}
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.4; cursor: default; }

.btn-primary {
  background: var(--wa-green);
  color: #fff;
}

.btn-danger {
  background: none;
  color: #f56565;
  padding: 6px 12px;
  font-size: 13px;
}
.btn-danger:hover { background: rgba(245,101,101,0.1); }

/* --- PROMPT EDITOR --- */
.prompt-textarea {
  min-height: 300px;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.5;
  tab-size: 4;
}

.prompt-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
}

.prompt-status {
  font-size: 12px;
  color: var(--wa-text-secondary);
}
.prompt-status.unsaved {
  color: #f6ad55;
}
.prompt-status.saved {
  color: var(--wa-green);
}

/* --- DOCUMENTS LIST --- */
.docs-section {
  background: var(--wa-sidebar);
  border-radius: 10px;
  padding: 20px;
  margin-top: 24px;
}

.docs-section h2 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.doc-count {
  font-size: 12px;
  background: var(--wa-green);
  color: #fff;
  padding: 2px 8px;
  border-radius: 10px;
}

.doc-list { list-style: none; }

.doc-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.doc-item:last-child { border-bottom: none; }

.doc-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.doc-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--wa-input-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.doc-meta .name { font-size: 14px; }
.doc-meta .detail {
  font-size: 12px;
  color: var(--wa-text-secondary);
  margin-top: 2px;
}

.empty-docs {
  text-align: center;
  padding: 30px;
  color: var(--wa-text-secondary);
  font-size: 14px;
}

/* --- CONVERSATIONS TAB --- */
.conv-layout {
  display: flex;
  gap: 16px;
  height: calc(100vh - 160px);
  min-height: 400px;
}

.conv-list {
  width: 280px;
  min-width: 280px;
  background: var(--wa-sidebar);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.conv-list-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--wa-border);
  font-size: 14px;
  font-weight: 500;
}

.conv-list-items {
  flex: 1;
  overflow-y: auto;
}

.conv-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  transition: background 0.15s;
}
.conv-item:hover { background: var(--wa-hover); }
.conv-item.active { background: var(--wa-input-bg); }

.conv-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.conv-dot.bot { background: #25D366; }
.conv-dot.handoff_pending { background: #f56565; }
.conv-dot.human { background: #f6ad55; }

.conv-item-info { flex: 1; min-width: 0; }
.conv-item-info .phone { font-size: 13px; font-weight: 500; }
.conv-item-info .preview {
  font-size: 12px;
  color: var(--wa-text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.conv-item .mode-label {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  flex-shrink: 0;
}
.mode-label.handoff_pending { background: rgba(245,101,101,0.2); color: #f56565; }
.mode-label.human { background: rgba(246,173,85,0.2); color: #f6ad55; }
.mode-label.bot { background: rgba(37,211,102,0.15); color: #25D366; }

.conv-detail {
  flex: 1;
  background: var(--wa-sidebar);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.conv-detail-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--wa-text-secondary);
  font-size: 14px;
}

.conv-detail-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--wa-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.conv-detail-header .info { flex: 1; }
.conv-detail-header .phone { font-size: 14px; font-weight: 500; }
.conv-detail-header .status { font-size: 12px; color: var(--wa-text-secondary); }
.conv-detail-header .actions { display: flex; gap: 8px; }

.btn-sm {
  padding: 6px 14px;
  border-radius: 6px;
  border: none;
  font-size: 12px;
  cursor: pointer;
  transition: opacity 0.15s;
}
.btn-sm:hover { opacity: 0.85; }
.btn-sm.green { background: var(--wa-green); color: #fff; }
.btn-sm.orange { background: #f6ad55; color: #111; }
.btn-sm.red { background: #f56565; color: #fff; }

.conv-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.conv-msg {
  max-width: 75%;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.4;
  word-wrap: break-word;
}
.conv-msg.user {
  align-self: flex-end;
  background: #005C4B;
  border-top-right-radius: 0;
}
.conv-msg.assistant {
  align-self: flex-start;
  background: var(--wa-input-bg);
  border-top-left-radius: 0;
}
.conv-msg.assistant .source-tag {
  font-size: 10px;
  font-weight: 600;
  margin-bottom: 2px;
}
.conv-msg.assistant .source-tag.bot { color: var(--wa-green); }
.conv-msg.assistant .source-tag.human { color: #f6ad55; }
.conv-msg.system-msg {
  align-self: center;
  background: rgba(255,255,255,0.08);
  color: var(--wa-text-secondary);
  font-size: 11px;
  text-align: center;
  max-width: 80%;
}
.conv-msg .time {
  font-size: 10px;
  color: rgba(255,255,255,0.4);
  margin-top: 2px;
  text-align: right;
}

.conv-reply-area {
  padding: 12px 16px;
  border-top: 1px solid var(--wa-border);
  display: flex;
  gap: 10px;
  align-items: center;
}
.conv-reply-area input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  background: var(--wa-input-bg);
  color: var(--wa-text);
  font-size: 13px;
  outline: none;
}
.conv-reply-area input::placeholder { color: var(--wa-text-secondary); }

.tab .badge-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #f56565;
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  min-width: 18px;
  height: 18px;
  border-radius: 9px;
  padding: 0 5px;
  margin-left: 6px;
}

@media (max-width: 600px) {
  .conv-layout { flex-direction: column; height: auto; }
  .conv-list { width: 100%; min-width: unset; max-height: 250px; }
}

/* --- TOAST --- */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 100;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--wa-green); color: #fff; }
.toast.error { background: #f56565; color: #fff; }

/* --- RESPONSIVE --- */
@media (max-width: 600px) {
  .container { padding: 12px; }
  .form-row { flex-direction: column; }
  .tab { padding: 10px 16px; font-size: 13px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Panel de Administracion</h1>
    <a href="/">&#8592; Volver al Chat</a>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="personalidad" onclick="switchTab('personalidad')">Personalidad</button>
    <button class="tab" data-tab="conocimiento" onclick="switchTab('conocimiento')">Conocimiento</button>
    <button class="tab" data-tab="conversaciones" id="tabConversaciones" onclick="switchTab('conversaciones')">Conversaciones</button>
  </div>

  <!-- TAB: PERSONALIDAD -->
  <div class="tab-content active" id="tab-personalidad">
    <div class="section">
      <h2>Prompt del Agente</h2>
      <p class="desc">Este es el "cerebro" de Nico. Edita las reglas, el tono, los descuentos, y como se comporta. Los cambios se aplican al instante en las proximas conversaciones.</p>
      <div class="form-row vertical">
        <div>
          <textarea id="systemPrompt" class="prompt-textarea" placeholder="Cargando prompt..."></textarea>
        </div>
        <div class="prompt-footer">
          <span class="prompt-status" id="promptStatus">Sin cambios</span>
          <button class="btn btn-primary" id="btnSavePrompt" onclick="savePrompt()" disabled>Guardar cambios</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Contexto por defecto para nuevas sesiones</h2>
      <p class="desc">Texto extra que se agrega al system prompt solo para esta demo. Las sesiones nuevas copian este valor. Se guarda en memoria (se pierde al reiniciar el servidor).</p>
      <div class="form-row vertical">
        <div>
          <textarea id="defaultPromptContext" class="prompt-textarea" placeholder="Ej: El cliente de esta sesion es Juan, prefiere que le hablen de vos. Hoy hay 10% de descuento en creatina." style="min-height:120px;"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveDefaultPromptContext()">Guardar contexto por defecto</button>
      </div>
    </div>
  </div>

  <!-- TAB: CONOCIMIENTO -->
  <div class="tab-content" id="tab-conocimiento">
    <!-- Upload PDF -->
    <div class="section">
      <h2>Subir PDF</h2>
      <p class="desc">Subir catalogo, lista de precios, o cualquier documento PDF. Se extrae el texto y se indexa automaticamente.</p>
      <div class="form-row">
        <label class="file-label" id="pdfLabel" for="pdfInput">Seleccionar PDF...</label>
        <input type="file" id="pdfInput" accept=".pdf" onchange="updateFileLabel('pdfInput','pdfLabel')">
        <button class="btn btn-primary" onclick="uploadPdf()">Subir</button>
      </div>
    </div>

    <!-- Audio transcript -->
    <div class="section">
      <h2>Transcripcion de audio</h2>
      <p class="desc">Pegar la transcripcion de un audio de un cliente. Esto le da contexto al agente sobre como hablan los clientes.</p>
      <div class="form-row vertical">
        <div>
          <label>Titulo</label>
          <input type="text" id="audioTitle" placeholder="Ej: Audio cliente Juan - consulta creatina">
        </div>
        <div>
          <label>Transcripcion</label>
          <textarea id="audioText" placeholder="Ej: Hola Mauri, te queria consultar por la creatina, estoy entrenando hace 3 meses..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addAudioTranscript()" style="align-self:flex-end;">Guardar</button>
      </div>
    </div>

    <!-- Chat export -->
    <div class="section">
      <h2>Importar chat de WhatsApp</h2>
      <p class="desc">Pegar un export de chat de WhatsApp. El agente aprende del historial de conversaciones reales.</p>
      <div class="form-row vertical">
        <div>
          <label>Titulo</label>
          <input type="text" id="chatTitle" placeholder="Ej: Chat con cliente Maria - febrero 2025">
        </div>
        <div>
          <label>Export del chat</label>
          <textarea id="chatText" placeholder="6/2/25, 10:30 - Juan: Hola, tienen creatina?&#10;6/2/25, 10:31 - Mauri: Si! Tenemos monohidrato de 300g..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addChatExport()" style="align-self:flex-end;">Importar</button>
      </div>
    </div>

    <!-- Free notes -->
    <div class="section">
      <h2>Nota libre</h2>
      <p class="desc">Agregar cualquier informacion adicional: FAQ, politicas, horarios, datos del negocio, etc.</p>
      <div class="form-row vertical">
        <div>
          <label>Titulo</label>
          <input type="text" id="noteTitle" placeholder="Ej: Horarios de atencion">
        </div>
        <div>
          <label>Contenido</label>
          <textarea id="noteText" placeholder="Ej: Atendemos de lunes a viernes de 9 a 18hs. Sabados de 9 a 13hs..."></textarea>
        </div>
        <button class="btn btn-primary" onclick="addNote()" style="align-self:flex-end;">Guardar</button>
      </div>
    </div>

    <!-- Documents list -->
    <div class="docs-section">
      <h2>Documentos indexados <span class="doc-count" id="docCount">0</span></h2>
      <ul class="doc-list" id="docList">
        <li class="empty-docs">No hay documentos. Subi archivos para que Nico los use como contexto.</li>
      </ul>
    </div>
  </div>

  <!-- TAB: CONVERSACIONES -->
  <div class="tab-content" id="tab-conversaciones">
    <div class="conv-layout">
      <!-- Left panel: session list -->
      <div class="conv-list">
        <div class="conv-list-header">Sesiones</div>
        <div class="conv-list-items" id="convListItems"></div>
      </div>
      <!-- Right panel: chat detail -->
      <div class="conv-detail" id="convDetail">
        <div class="conv-detail-empty" id="convEmpty">Selecciona una conversacion</div>
        <div id="convActive" style="display:none;flex:1;flex-direction:column;">
          <div class="conv-detail-header">
            <div class="info">
              <div class="phone" id="convPhone"></div>
              <div class="status" id="convStatus"></div>
            </div>
            <div class="actions" id="convActions"></div>
          </div>
          <div class="conv-messages" id="convMessages"></div>
          <div class="conv-reply-area" id="convReplyArea">
            <input type="text" id="convReplyInput" placeholder="Responder como operador..." onkeydown="if(event.key==='Enter')sendOperatorReply()">
            <button class="btn-sm green" onclick="sendOperatorReply()">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// --- TABS ---
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');

  // Manage conversations polling
  if (tabName === 'conversaciones') {
    startConvPolling();
  } else {
    stopConvPolling();
  }
}

// --- PROMPT EDITOR ---
let originalPrompt = '';

async function loadPrompt() {
  try {
    const res = await fetch('/api/config/prompt');
    const data = await res.json();
    const textarea = document.getElementById('systemPrompt');
    textarea.value = data.system_prompt;
    originalPrompt = data.system_prompt;
    updatePromptStatus();
  } catch (e) {
    console.error('Failed to load prompt:', e);
  }
}

async function savePrompt() {
  const text = document.getElementById('systemPrompt').value;
  if (!text.trim()) return showToast('El prompt no puede estar vacio', 'error');

  try {
    const res = await fetch('/api/config/prompt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ system_prompt: text }),
    });
    if (!res.ok) throw new Error();
    originalPrompt = text;
    updatePromptStatus();
    showToast('Prompt actualizado. Los cambios ya estan activos.');
  } catch (e) {
    showToast('Error al guardar el prompt', 'error');
  }
}

function updatePromptStatus() {
  const textarea = document.getElementById('systemPrompt');
  const status = document.getElementById('promptStatus');
  const btn = document.getElementById('btnSavePrompt');
  const changed = textarea.value !== originalPrompt;

  if (changed) {
    status.textContent = 'Cambios sin guardar';
    status.className = 'prompt-status unsaved';
    btn.disabled = false;
  } else {
    status.textContent = 'Sin cambios';
    status.className = 'prompt-status';
    btn.disabled = true;
  }
}

// --- DEFAULT PROMPT CONTEXT ---
async function loadDefaultPromptContext() {
  try {
    const res = await fetch('/api/config/prompt-context');
    const data = await res.json();
    document.getElementById('defaultPromptContext').value = data.prompt_context || '';
  } catch (e) {
    console.error('Failed to load default prompt context:', e);
  }
}

async function saveDefaultPromptContext() {
  const text = document.getElementById('defaultPromptContext').value;
  try {
    const res = await fetch('/api/config/prompt-context', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt_context: text || '' }),
    });
    if (!res.ok) throw new Error();
    showToast('Contexto por defecto guardado. Las nuevas sesiones lo usaran.');
  } catch (e) {
    showToast('Error al guardar', 'error');
  }
}

// --- KNOWLEDGE BASE ---
const TYPE_ICONS = {
  pdf: '\u{1F4C4}', audio_transcript: '\u{1F3A4}', chat_history: '\u{1F4AC}', note: '\u{1F4DD}'
};
const TYPE_LABELS = {
  pdf: 'PDF', audio_transcript: 'Audio', chat_history: 'Chat WA', note: 'Nota'
};

function updateFileLabel(inputId, labelId) {
  const input = document.getElementById(inputId);
  const label = document.getElementById(labelId);
  if (input.files.length > 0) {
    label.textContent = input.files[0].name;
    label.classList.add('has-file');
  }
}

// --- Toast ---
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// --- API ---
async function uploadPdf() {
  const input = document.getElementById('pdfInput');
  if (!input.files.length) return showToast('Selecciona un PDF primero', 'error');

  const form = new FormData();
  form.append('file', input.files[0]);

  try {
    const res = await fetch('/api/knowledge/upload', { method: 'POST', body: form });
    if (!res.ok) throw new Error('Upload failed');
    const data = await res.json();
    showToast(`PDF indexado: ${data.chunk_count} fragmentos`);
    input.value = '';
    document.getElementById('pdfLabel').textContent = 'Seleccionar PDF...';
    document.getElementById('pdfLabel').classList.remove('has-file');
    loadDocuments();
  } catch (e) {
    showToast('Error al subir PDF', 'error');
  }
}

async function addAudioTranscript() {
  const title = document.getElementById('audioTitle').value.trim();
  const text = document.getElementById('audioText').value.trim();
  if (!title || !text) return showToast('Completa titulo y texto', 'error');

  const form = new FormData();
  form.append('title', title);
  form.append('text', text);
  form.append('doc_type', 'audio_transcript');

  try {
    const res = await fetch('/api/knowledge/text', { method: 'POST', body: form });
    if (!res.ok) throw new Error();
    const data = await res.json();
    showToast(`Audio indexado: ${data.chunk_count} fragmentos`);
    document.getElementById('audioTitle').value = '';
    document.getElementById('audioText').value = '';
    loadDocuments();
  } catch (e) {
    showToast('Error al guardar', 'error');
  }
}

async function addChatExport() {
  const title = document.getElementById('chatTitle').value.trim();
  const text = document.getElementById('chatText').value.trim();
  if (!title || !text) return showToast('Completa titulo y chat', 'error');

  const form = new FormData();
  form.append('title', title);
  form.append('text', text);

  try {
    const res = await fetch('/api/knowledge/chat-export', { method: 'POST', body: form });
    if (!res.ok) throw new Error();
    const data = await res.json();
    showToast(`Chat importado: ${data.chunk_count} bloques`);
    document.getElementById('chatTitle').value = '';
    document.getElementById('chatText').value = '';
    loadDocuments();
  } catch (e) {
    showToast('Error al importar', 'error');
  }
}

async function addNote() {
  const title = document.getElementById('noteTitle').value.trim();
  const text = document.getElementById('noteText').value.trim();
  if (!title || !text) return showToast('Completa titulo y contenido', 'error');

  const form = new FormData();
  form.append('title', title);
  form.append('text', text);
  form.append('doc_type', 'note');

  try {
    const res = await fetch('/api/knowledge/text', { method: 'POST', body: form });
    if (!res.ok) throw new Error();
    const data = await res.json();
    showToast(`Nota guardada: ${data.chunk_count} fragmentos`);
    document.getElementById('noteTitle').value = '';
    document.getElementById('noteText').value = '';
    loadDocuments();
  } catch (e) {
    showToast('Error al guardar', 'error');
  }
}

async function deleteDoc(docId) {
  try {
    const res = await fetch(`/api/knowledge/documents/${docId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error();
    showToast('Documento eliminado');
    loadDocuments();
  } catch (e) {
    showToast('Error al eliminar', 'error');
  }
}

async function loadDocuments() {
  try {
    const res = await fetch('/api/knowledge/documents');
    const docs = await res.json();
    const list = document.getElementById('docList');
    const count = document.getElementById('docCount');
    count.textContent = docs.length;

    if (docs.length === 0) {
      list.innerHTML = '<li class="empty-docs">No hay documentos. Subi archivos para que Nico los use como contexto.</li>';
      return;
    }

    list.innerHTML = docs.map(d => `
      <li class="doc-item">
        <div class="doc-info">
          <div class="doc-icon">${TYPE_ICONS[d.doc_type] || '\u{1F4C4}'}</div>
          <div class="doc-meta">
            <div class="name">${escapeHtml(d.filename)}</div>
            <div class="detail">${TYPE_LABELS[d.doc_type] || d.doc_type} &middot; ${d.chunk_count} fragmentos</div>
          </div>
        </div>
        <button class="btn btn-danger" onclick="deleteDoc('${d.id}')">Eliminar</button>
      </li>
    `).join('');
  } catch (e) {
    console.error('Failed to load documents:', e);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// --- CONVERSATIONS TAB ---
let convSessions = [];
let convSelectedId = null;
let convPollTimer = null;
let pendingPollTimer = null;

const MODE_LABELS = {
  bot: 'Bot',
  handoff_pending: 'Pendiente',
  human: 'Humano',
};

async function loadConvSessions() {
  try {
    const res = await fetch('/api/sessions');
    convSessions = await res.json();
    renderConvList();
    // If a session is selected, refresh it too
    if (convSelectedId) {
      const still = convSessions.find(s => s.id === convSelectedId);
      if (still) await loadConvDetail(convSelectedId);
    }
  } catch (e) {
    console.error('Failed to load conv sessions:', e);
  }
}

function renderConvList() {
  const container = document.getElementById('convListItems');
  if (!container) return;
  // Sort: handoff_pending first, then human, then bot
  const order = { handoff_pending: 0, human: 1, bot: 2 };
  const sorted = [...convSessions].sort((a, b) => (order[a.mode] ?? 2) - (order[b.mode] ?? 2));

  container.innerHTML = sorted.map(s => `
    <div class="conv-item ${s.id === convSelectedId ? 'active' : ''}" onclick="selectConvSession('${s.id}')">
      <div class="conv-dot ${s.mode || 'bot'}"></div>
      <div class="conv-item-info">
        <div class="phone">${escapeHtml(s.phone_number)}</div>
        <div class="preview">${s.last_message ? escapeHtml(s.last_message) : 'Sin mensajes'}</div>
      </div>
      <span class="mode-label ${s.mode || 'bot'}">${MODE_LABELS[s.mode] || 'Bot'}</span>
    </div>
  `).join('');
}

async function selectConvSession(sessionId) {
  convSelectedId = sessionId;
  renderConvList();
  await loadConvDetail(sessionId);
}

async function loadConvDetail(sessionId) {
  try {
    const res = await fetch(`/api/sessions/${sessionId}`);
    const session = await res.json();

    document.getElementById('convEmpty').style.display = 'none';
    const active = document.getElementById('convActive');
    active.style.display = 'flex';

    document.getElementById('convPhone').textContent = session.phone_number;
    const statusParts = [MODE_LABELS[session.mode] || 'Bot'];
    if (session.handoff_reason) statusParts.push(session.handoff_reason);
    if (session.handoff_at) {
      const d = new Date(session.handoff_at);
      statusParts.push(d.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' }));
    }
    document.getElementById('convStatus').textContent = statusParts.join(' · ');

    // Render action buttons
    const actions = document.getElementById('convActions');
    if (session.mode === 'handoff_pending') {
      actions.innerHTML = `<button class="btn-sm green" onclick="takeConversation()">Tomar conversacion</button>`;
    } else if (session.mode === 'human') {
      actions.innerHTML = `<button class="btn-sm orange" onclick="returnToBot()">Devolver al bot</button>`;
    } else {
      actions.innerHTML = `<button class="btn-sm red" onclick="manualHandoff()">Derivar manualmente</button>`;
    }

    // Render messages
    const msgContainer = document.getElementById('convMessages');
    msgContainer.innerHTML = session.messages.map(m => {
      if (m.source === 'system') {
        return `<div class="conv-msg system-msg">${escapeHtml(m.content)}<div class="time">${m.timestamp || ''}</div></div>`;
      }
      const roleClass = m.role === 'user' ? 'user' : 'assistant';
      let sourceTag = '';
      if (m.role === 'assistant' && m.source === 'human') {
        sourceTag = `<div class="source-tag human">OPERADOR</div>`;
      } else if (m.role === 'assistant' && m.source === 'bot') {
        sourceTag = `<div class="source-tag bot">NICO</div>`;
      }
      return `<div class="conv-msg ${roleClass}">${sourceTag}${escapeHtml(m.content)}<div class="time">${m.timestamp || ''}</div></div>`;
    }).join('');
    msgContainer.scrollTop = msgContainer.scrollHeight;

    // Show/hide reply area
    const replyArea = document.getElementById('convReplyArea');
    replyArea.style.display = (session.mode === 'handoff_pending' || session.mode === 'human') ? 'flex' : 'none';
  } catch (e) {
    console.error('Failed to load conv detail:', e);
  }
}

async function takeConversation() {
  if (!convSelectedId) return;
  try {
    await fetch(`/api/sessions/${convSelectedId}/handoff`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'human' }),
    });
    showToast('Conversacion tomada');
    await loadConvSessions();
  } catch (e) {
    showToast('Error al tomar conversacion', 'error');
  }
}

async function returnToBot() {
  if (!convSelectedId) return;
  try {
    await fetch(`/api/sessions/${convSelectedId}/handoff`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'bot' }),
    });
    showToast('Conversacion devuelta al bot');
    await loadConvSessions();
  } catch (e) {
    showToast('Error al devolver', 'error');
  }
}

async function manualHandoff() {
  if (!convSelectedId) return;
  try {
    await fetch(`/api/sessions/${convSelectedId}/handoff`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'handoff_pending', reason: 'Derivacion manual desde admin' }),
    });
    showToast('Sesion derivada');
    await loadConvSessions();
  } catch (e) {
    showToast('Error al derivar', 'error');
  }
}

async function sendOperatorReply() {
  if (!convSelectedId) return;
  const input = document.getElementById('convReplyInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  try {
    await fetch(`/api/sessions/${convSelectedId}/reply`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });
    await loadConvDetail(convSelectedId);
    await loadConvSessions();
  } catch (e) {
    showToast('Error al enviar respuesta', 'error');
  }
}

async function pollPendingHandoffs() {
  try {
    const res = await fetch('/api/handoffs/pending');
    const data = await res.json();
    const tab = document.getElementById('tabConversaciones');
    const existing = tab.querySelector('.badge-count');
    if (data.count > 0) {
      if (existing) {
        existing.textContent = data.count;
      } else {
        const badge = document.createElement('span');
        badge.className = 'badge-count';
        badge.textContent = data.count;
        tab.appendChild(badge);
      }
      document.title = `(${data.count}) Admin - La Formula`;
    } else {
      if (existing) existing.remove();
      document.title = 'Admin - La Formula';
    }
  } catch (e) { /* ignore */ }
}

function startConvPolling() {
  stopConvPolling();
  loadConvSessions();
  convPollTimer = setInterval(loadConvSessions, 5000);
}

function stopConvPolling() {
  if (convPollTimer) { clearInterval(convPollTimer); convPollTimer = null; }
}

// --- INIT ---
document.getElementById('systemPrompt').addEventListener('input', updatePromptStatus);
loadPrompt();
loadDefaultPromptContext();
loadDocuments();

// Start pending handoffs polling (always active)
pollPendingHandoffs();
pendingPollTimer = setInterval(pollPendingHandoffs, 10000);
</script>
</body>
</html>
