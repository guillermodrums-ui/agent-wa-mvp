<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>La F√≥rmula - WhatsApp Agent</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --wa-green: #25D366;
      --wa-dark: #111B21;
      --wa-sidebar: #202C33;
      --wa-chat-bg: #0B141A;
      --wa-input-bg: #2A3942;
      --wa-header: #202C33;
      --wa-bubble-out: #005C4B;
      --wa-bubble-in: #202C33;
      --wa-text: #E9EDEF;
      --wa-text-secondary: #8696A0;
      --wa-border: #2A3942;
      --wa-hover: #2A3942;
      --sim-accent: #3B82F6;
      --prod-accent: #F59E0B;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--wa-dark);
      color: var(--wa-text);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      height: 100vh;
    }

    /* === NAV SIDEBAR === */
    .nav-sidebar {
      width: 70px;
      background: #0d1117;
      border-right: 1px solid var(--wa-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      gap: 8px;
    }

    .nav-item {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: none;
      border: none;
      color: var(--wa-text-secondary);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .nav-item:hover {
      background: var(--wa-hover);
      color: var(--wa-text);
    }

    .nav-item.active {
      background: var(--wa-green);
      color: #fff;
    }

    .nav-item.active.sim {
      background: var(--sim-accent);
    }

    .nav-item.active.prod {
      background: var(--prod-accent);
    }

    .nav-item .badge {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f56565;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* === MAIN CONTENT === */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .view {
      display: none !important;
      flex: 1;
    }

    .view.active {
      display: flex !important;
    }

    /* === SIMULADOR VIEW === */
    .sim-view {
      flex-direction: column;
    }

    .sim-header {
      padding: 16px 24px;
      background: var(--wa-header);
      border-bottom: 1px solid var(--wa-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sim-header h1 {
      font-size: 18px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sim-header .badge-sim {
      background: var(--sim-accent);
      color: #fff;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .sim-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sim-config {
      width: 350px;
      background: var(--wa-sidebar);
      border-right: 1px solid var(--wa-border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 20px;
    }

    .sim-config h3 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      color: var(--wa-text);
    }

    .sim-config label {
      font-size: 12px;
      color: var(--wa-text-secondary);
      margin-bottom: 6px;
      display: block;
    }

    .sim-config textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--wa-border);
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      resize: vertical;
      outline: none;
      line-height: 1.5;
    }

    .sim-config textarea:focus {
      border-color: var(--sim-accent);
    }

    .sim-config .hint {
      font-size: 11px;
      color: var(--wa-text-secondary);
      margin-top: 6px;
      line-height: 1.4;
    }

    .sim-config .btn-reset {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .sim-config .btn-reset:hover {
      background: var(--wa-hover);
    }

    .sim-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--wa-chat-bg);
    }

    .sim-chat-header {
      padding: 12px 20px;
      background: var(--wa-header);
      border-bottom: 1px solid var(--wa-border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sim-chat-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--sim-accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .sim-chat-header .info .name {
      font-size: 15px;
      font-weight: 500;
    }

    .sim-chat-header .info .status {
      font-size: 12px;
      color: var(--wa-text-secondary);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 60px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message {
      max-width: 65%;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background: var(--wa-bubble-out);
      border-top-right-radius: 0;
    }

    .message.assistant {
      align-self: flex-start;
      background: var(--wa-bubble-in);
      border-top-left-radius: 0;
    }

    .message .time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 4px;
      text-align: right;
    }

    .typing-indicator {
      align-self: flex-start;
      background: var(--wa-bubble-in);
      padding: 12px 16px;
      border-radius: 8px;
      border-top-left-radius: 0;
      display: none;
    }

    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--wa-text-secondary);
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.4;
      }

      30% {
        transform: translateY(-6px);
        opacity: 1;
      }
    }

    .input-area {
      padding: 14px 20px;
      background: var(--wa-header);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: none;
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 14px;
      outline: none;
    }

    .input-area input::placeholder {
      color: var(--wa-text-secondary);
    }

    .btn-send {
      background: var(--wa-green);
      border: none;
      color: #fff;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.15s;
    }

    .btn-send:hover {
      opacity: 0.85;
    }

    .btn-send:disabled {
      opacity: 0.4;
      cursor: default;
    }

    /* === PRODUCCION VIEW === */
    .prod-view {}

    .prod-list {
      width: 320px;
      background: var(--wa-sidebar);
      border-right: 1px solid var(--wa-border);
      display: flex;
      flex-direction: column;
    }

    .prod-list-header {
      padding: 16px;
      background: var(--wa-header);
      border-bottom: 1px solid var(--wa-border);
    }

    .prod-list-header h2 {
      font-size: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-prod {
      background: var(--prod-accent);
      color: #111;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .prod-list-items {
      flex: 1;
      overflow-y: auto;
    }

    .prod-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.15s;
    }

    .prod-item:hover {
      background: var(--wa-hover);
    }

    .prod-item.active {
      background: var(--wa-input-bg);
    }

    .prod-item .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--wa-input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .prod-item .info {
      flex: 1;
      min-width: 0;
    }

    .prod-item .info .phone {
      font-size: 14px;
      font-weight: 500;
    }

    .prod-item .info .preview {
      font-size: 13px;
      color: var(--wa-text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .prod-detail {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--wa-chat-bg);
    }

    .prod-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--wa-text-secondary);
      font-size: 14px;
    }

    .prod-chat-header {
      padding: 12px 20px;
      background: var(--wa-header);
      border-bottom: 1px solid var(--wa-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .prod-chat-header .info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .prod-chat-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--prod-accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #111;
    }

    .prod-chat-header .details .phone {
      font-size: 15px;
      font-weight: 500;
    }

    .prod-chat-header .details .status {
      font-size: 12px;
      color: var(--wa-text-secondary);
    }

    /* === CEREBRO VIEW === */
    .cerebro-view {
      flex-direction: column;
      overflow-y: auto;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .cerebro-view h1 {
      font-size: 22px;
      font-weight: 500;
      margin-bottom: 24px;
    }

    .section {
      background: var(--wa-sidebar);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .section p.desc {
      font-size: 13px;
      color: var(--wa-text-secondary);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .section textarea {
      width: 100%;
      min-height: 250px;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid var(--wa-border);
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      resize: vertical;
      outline: none;
      line-height: 1.6;
    }

    .section textarea:focus {
      border-color: var(--wa-green);
    }

    .section .btn-primary {
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      background: var(--wa-green);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.15s;
      margin-top: 12px;
    }

    .section .btn-primary:hover {
      opacity: 0.85;
    }

    .section .btn-primary:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .form-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .form-row.vertical {
      flex-direction: column;
      align-items: stretch;
    }

    .form-row label {
      font-size: 13px;
      color: var(--wa-text-secondary);
      margin-bottom: 6px;
      display: block;
    }

    .form-row input[type="text"] {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--wa-border);
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 14px;
      outline: none;
    }

    .form-row input[type="text"]:focus {
      border-color: var(--wa-green);
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--wa-input-bg);
      border: 1px dashed var(--wa-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--wa-text-secondary);
      transition: border-color 0.15s;
      flex: 1;
    }

    .file-label:hover {
      border-color: var(--wa-green);
      color: var(--wa-text);
    }

    .file-label.has-file {
      border-color: var(--wa-green);
      color: var(--wa-green);
    }

    input[type="file"] {
      display: none;
    }

    .doc-list {
      list-style: none;
      margin-top: 16px;
    }

    .doc-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .doc-item:last-child {
      border-bottom: none;
    }

    .doc-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .doc-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--wa-input-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .doc-meta .name {
      font-size: 14px;
    }

    .doc-meta .detail {
      font-size: 12px;
      color: var(--wa-text-secondary);
      margin-top: 2px;
    }

    .btn-danger {
      background: none;
      color: #f56565;
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-danger:hover {
      background: rgba(245, 101, 101, 0.1);
    }

    .empty-docs {
      text-align: center;
      padding: 30px;
      color: var(--wa-text-secondary);
      font-size: 14px;
    }

    /* === TOAST === */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--wa-green);
      color: #fff;
    }

    .toast.error {
      background: #f56565;
      color: #fff;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .sim-config {
        width: 100%;
        position: absolute;
        z-index: 10;
      }

      .sim-config.hidden {
        display: none;
      }

      .messages {
        padding: 12px 16px;
      }

      .message {
        max-width: 85%;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- NAV SIDEBAR -->
    <div class="nav-sidebar">
      <button class="nav-item active sim" data-view="simulador" onclick="switchView('simulador')" title="Simulador">
        üß™
      </button>
      <button class="nav-item prod" data-view="produccion" onclick="switchView('produccion')" title="Producci√≥n">
        üí¨
        <span class="badge" id="prodBadge" style="display:none;">0</span>
      </button>
      <button class="nav-item" data-view="cerebro" onclick="switchView('cerebro')" title="Cerebro">
        ‚öôÔ∏è
      </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- SIMULADOR VIEW -->
      <div class="view sim-view active" id="view-simulador">
        <div class="sim-header">
          <h1>üß™ Simulador <span class="badge-sim">PRUEBAS</span></h1>
        </div>
        <div class="sim-body">
          <div class="sim-config">
            <h3>‚ö° Configuraci√≥n de Prueba</h3>
            <label>System Prompt (solo para esta sesi√≥n)</label>
            <textarea id="simPrompt" placeholder="Dej√° vac√≠o para usar el prompt de producci√≥n..."></textarea>
            <p class="hint">üí° Edit√° el prompt ac√° para probar cambios sin afectar producci√≥n. Los cambios
              solo aplican a esta sesi√≥n de simulaci√≥n.</p>
            <button class="btn-reset" onclick="resetSimPrompt()">Restaurar prompt de producci√≥n</button>
          </div>
          <div class="sim-chat">
            <div class="sim-chat-header">
              <div class="avatar">ü§ñ</div>
              <div class="info">
                <div class="name" id="simAgentName">Nico - Simulador</div>
                <div class="status">Modo prueba</div>
              </div>
            </div>
            <div class="messages" id="simMessages">
              <div class="typing-indicator" id="simTyping">
                <span></span><span></span><span></span>
              </div>
            </div>
            <div class="input-area">
              <input type="text" id="simInput" placeholder="Escrib√≠ un mensaje de prueba..."
                onkeydown="if(event.key==='Enter')sendSimMessage()">
              <button class="btn-send" onclick="sendSimMessage()">‚û§</button>
            </div>
          </div>
        </div>
      </div>

      <!-- PRODUCCION VIEW -->
      <div class="view prod-view" id="view-produccion">
        <div class="prod-list">
          <div class="prod-list-header">
            <h2>üí¨ Mensajes <span class="badge-prod" id="prodCount">0</span></h2>
          </div>
          <div class="prod-list-items" id="prodList"></div>
        </div>
        <div class="prod-detail">
          <div class="prod-empty" id="prodEmpty">Seleccion√° una conversaci√≥n</div>
          <div id="prodActive" style="display:none;flex:1;flex-direction:column;">
            <div class="prod-chat-header">
              <div class="info">
                <div class="avatar">üì±</div>
                <div class="details">
                  <div class="phone" id="prodPhone"></div>
                  <div class="status" id="prodStatus"></div>
                </div>
              </div>
            </div>
            <div class="messages" id="prodMessages"></div>
            <div class="input-area">
              <input type="text" id="prodInput" placeholder="Responder como operador..."
                onkeydown="if(event.key==='Enter')sendProdReply()">
              <button class="btn-send" onclick="sendProdReply()">‚û§</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CEREBRO VIEW -->
      <div class="view cerebro-view" id="view-cerebro">
        <h1>‚öôÔ∏è Cerebro del Agente</h1>

        <div class="section">
          <h2>üß† Prompt del Agente (Producci√≥n)</h2>
          <p class="desc">Este es el prompt que usa Nico en producci√≥n. Los cambios se aplican inmediatamente.
          </p>
          <textarea id="prodPrompt" placeholder="Cargando..."></textarea>
          <button class="btn-primary" onclick="savePrompt()">Guardar cambios</button>
        </div>

        <div class="section">
          <h2>üìö Base de Conocimiento</h2>
          <p class="desc">Sub√≠ documentos PDF, transcripciones, o notas para que Nico las use como contexto.
          </p>

          <div class="form-row" style="margin-bottom:20px;">
            <label class="file-label" id="pdfLabel" for="pdfInput">üìÑ Seleccionar PDF...</label>
            <input type="file" id="pdfInput" accept=".pdf" onchange="updateFileLabel('pdfInput','pdfLabel')">
            <button class="btn-primary" onclick="uploadPdf()">Subir</button>
          </div>

          <div class="form-row vertical">
            <div>
              <label>T√≠tulo</label>
              <input type="text" id="noteTitle" placeholder="Ej: Horarios de atenci√≥n">
            </div>
            <div>
              <label>Contenido</label>
              <textarea id="noteText" placeholder="Ej: Atendemos de lunes a viernes..."
                style="min-height:100px;"></textarea>
            </div>
            <button class="btn-primary" onclick="addNote()" style="align-self:flex-end;">Guardar
              nota</button>
          </div>

          <h3 style="margin-top:24px;font-size:14px;font-weight:500;">Documentos indexados</h3>
          <ul class="doc-list" id="docList">
            <li class="empty-docs">No hay documentos</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let currentView = 'simulador';
    let simSessionId = null;
    let prodSessionId = null;
    let productionSessions = [];
    let productionPrompt = '';

    // === INIT ===
    async function init() {
      try {
        const config = await api('/api/config');
        document.getElementById('simAgentName').textContent = `${config.agent_name} - Simulador`;

        // Load production prompt
        const promptData = await api('/api/config/prompt');
        productionPrompt = promptData.system_prompt;
        document.getElementById('prodPrompt').value = productionPrompt;

        // Create simulation session
        await createSimSession();

        // Load production sessions
        await loadProductionSessions();

        // Load documents
        await loadDocuments();
      } catch (e) {
        console.error('Init failed:', e);
      }
    }

    // === API ===
    async function api(path, options = {}) {
      const res = await fetch(path, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return res.json();
    }

    // === VIEW SWITCHING ===
    function switchView(viewName) {
      currentView = viewName;
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById(`view-${viewName}`).classList.add('active');
      document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

      if (viewName === 'produccion') {
        loadProductionSessions();
      }
    }

    // === SIMULADOR ===
    async function createSimSession() {
      const data = await api('/api/sessions', {
        method: 'POST',
        body: JSON.stringify({ is_simulation: true }),
      });
      simSessionId = data.id;
    }

    function resetSimPrompt() {
      document.getElementById('simPrompt').value = '';
      showToast('Prompt restaurado. El pr√≥ximo mensaje usar√° el prompt de producci√≥n.');
    }

    async function sendSimMessage() {
      const input = document.getElementById('simInput');
      const text = input.value.trim();
      if (!text || !simSessionId) return;

      input.value = '';
      addSimMessage('user', text);
      showSimTyping(true);

      try {
        const customPrompt = document.getElementById('simPrompt').value.trim();
        const body = {
          session_id: simSessionId,
          message: text,
        };
        if (customPrompt) {
          body.system_prompt_override = customPrompt;
        }

        const data = await api('/api/chat', { method: 'POST', body: JSON.stringify(body) });
        showSimTyping(false);

        if (data.reply) {
          addSimMessage('assistant', data.reply, data.timestamp);
        }
      } catch (e) {
        showSimTyping(false);
        addSimMessage('assistant', '[Error al conectar con el agente]');
      }
    }

    function addSimMessage(role, content, time) {
      const container = document.getElementById('simMessages');
      const indicator = document.getElementById('simTyping');
      const div = document.createElement('div');
      div.className = `message ${role}`;

      const now = time || new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = `${escapeHtml(content)}<div class="time">${now}</div>`;

      container.insertBefore(div, indicator);
      container.scrollTop = container.scrollHeight;
    }

    function showSimTyping(show) {
      document.getElementById('simTyping').style.display = show ? 'block' : 'none';
    }

    // === PRODUCCION ===
    async function loadProductionSessions() {
      try {
        productionSessions = await api('/api/sessions?is_simulation=false');
        renderProductionList();
      } catch (e) {
        console.error('Failed to load production sessions:', e);
      }
    }

    function renderProductionList() {
      const list = document.getElementById('prodList');
      const count = document.getElementById('prodCount');
      const badge = document.getElementById('prodBadge');

      count.textContent = productionSessions.length;

      if (productionSessions.length > 0) {
        badge.textContent = productionSessions.length;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }

      if (productionSessions.length === 0) {
        list.innerHTML = '<div class="empty-docs">No hay conversaciones de producci√≥n</div>';
        return;
      }

      list.innerHTML = productionSessions.map(s => `
    <div class="prod-item" data-id="${s.id}" onclick="selectProdSession('${s.id}')">
      <div class="avatar">üì±</div>
      <div class="info">
        <div class="phone">${s.phone_number}</div>
        <div class="preview">${s.last_message || 'Sin mensajes'}</div>
      </div>
    </div>
  `).join('');
    }

    async function selectProdSession(sessionId) {
      prodSessionId = sessionId;

      document.querySelectorAll('.prod-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-id="${sessionId}"]`)?.classList.add('active');

      const session = await api(`/api/sessions/${sessionId}`);

      document.getElementById('prodEmpty').style.display = 'none';
      document.getElementById('prodActive').style.display = 'flex';
      document.getElementById('prodPhone').textContent = session.phone_number;
      document.getElementById('prodStatus').textContent = `${session.message_count || 0} mensajes`;

      renderProdMessages(session.messages);
    }

    function renderProdMessages(messages) {
      const container = document.getElementById('prodMessages');
      container.innerHTML = '';

      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message ${msg.role}`;
        div.innerHTML = `${escapeHtml(msg.content)}<div class="time">${msg.timestamp}</div>`;
        container.appendChild(div);
      });

      container.scrollTop = container.scrollHeight;
    }

    async function sendProdReply() {
      const input = document.getElementById('prodInput');
      const text = input.value.trim();
      if (!text || !prodSessionId) return;

      input.value = '';

      try {
        await api(`/api/sessions/${prodSessionId}/reply`, {
          method: 'POST',
          body: JSON.stringify({ message: text }),
        });

        const session = await api(`/api/sessions/${prodSessionId}`);
        renderProdMessages(session.messages);
        await loadProductionSessions();
      } catch (e) {
        showToast('Error al enviar mensaje', 'error');
      }
    }

    // === CEREBRO ===
    async function savePrompt() {
      const text = document.getElementById('prodPrompt').value;
      if (!text.trim()) return showToast('El prompt no puede estar vac√≠o', 'error');

      try {
        await api('/api/config/prompt', {
          method: 'POST',
          body: JSON.stringify({ system_prompt: text }),
        });
        productionPrompt = text;
        showToast('Prompt actualizado en producci√≥n');
      } catch (e) {
        showToast('Error al guardar el prompt', 'error');
      }
    }

    async function uploadPdf() {
      const input = document.getElementById('pdfInput');
      if (!input.files.length) return showToast('Seleccion√° un PDF primero', 'error');

      const form = new FormData();
      form.append('file', input.files[0]);

      try {
        const res = await fetch('/api/knowledge/upload', { method: 'POST', body: form });
        if (!res.ok) throw new Error('Upload failed');
        const data = await res.json();
        showToast(`PDF indexado: ${data.chunk_count} fragmentos`);
        input.value = '';
        document.getElementById('pdfLabel').textContent = 'üìÑ Seleccionar PDF...';
        document.getElementById('pdfLabel').classList.remove('has-file');
        loadDocuments();
      } catch (e) {
        showToast('Error al subir PDF', 'error');
      }
    }

    async function addNote() {
      const title = document.getElementById('noteTitle').value.trim();
      const text = document.getElementById('noteText').value.trim();

      if (!title || !text) return showToast('Complet√° t√≠tulo y contenido', 'error');

      try {
        const form = new FormData();
        form.append('title', title);
        form.append('text', text);
        form.append('doc_type', 'note');

        const res = await fetch('/api/knowledge/text', { method: 'POST', body: form });
        if (!res.ok) throw new Error('Failed');

        showToast('Nota guardada');
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteText').value = '';
        loadDocuments();
      } catch (e) {
        showToast('Error al guardar nota', 'error');
      }
    }

    async function loadDocuments() {
      try {
        const docs = await api('/api/knowledge/documents');
        const list = document.getElementById('docList');

        if (docs.length === 0) {
          list.innerHTML = '<li class="empty-docs">No hay documentos</li>';
          return;
        }

        const TYPE_ICONS = { pdf: 'üìÑ', note: 'üìù', audio_transcript: 'üé§', chat_history: 'üí¨' };

        list.innerHTML = docs.map(doc => `
      <li class="doc-item">
        <div class="doc-info">
          <div class="doc-icon">${TYPE_ICONS[doc.doc_type] || 'üìÑ'}</div>
          <div class="doc-meta">
            <div class="name">${doc.filename}</div>
            <div class="detail">${doc.chunk_count} fragmentos</div>
          </div>
        </div>
        <button class="btn-danger" onclick="deleteDocument('${doc.id}')">Eliminar</button>
      </li>
    `).join('');
      } catch (e) {
        console.error('Failed to load documents:', e);
      }
    }

    async function deleteDocument(docId) {
      if (!confirm('¬øEliminar este documento?')) return;

      try {
        await api(`/api/knowledge/documents/${docId}`, { method: 'DELETE' });
        showToast('Documento eliminado');
        loadDocuments();
      } catch (e) {
        showToast('Error al eliminar', 'error');
      }
    }

    // === UTILS ===
    function updateFileLabel(inputId, labelId) {
      const input = document.getElementById(inputId);
      const label = document.getElementById(labelId);
      if (input.files.length > 0) {
        label.textContent = input.files[0].name;
        label.classList.add('has-file');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Start
    init();
  </script>
</body>

</html>